# ACTIVITI 简明教程

**简介：**

> Activiti is battle-tested Business Process Management.

> Activiti 是一个久经实战的业务工作流管理器

我们通常在使用ACTIVITI集成的时候会使用到如下内容：

1. **核心引擎 ProgressEngine**
1. **[事件监听 ActivitiEventListener](#事件监听 ActivitiEventListener)**

## 核心引擎 ProgressEngine

<img src="https://www.activiti.org/userguide/images/api.services.png"/>

如上图所示，主要有7个SERVICE提供服务，其中又分重点和非重点：

**重点（常用）**

- RepositoryService
- RuntimeService
- TaskService


**注**：以下`规则`特指`业务流程规则（progress）`

### 规则仓库 RepositoryService

> The RepositoryService is probably the first service needed when working with the Activiti engine.

> 通常我们使用`Activiti`时第一个用到的服务就是`RepositoryService`

此服务提供流程的规则管理：规则**查询**、规则**控制**、规则**创建**、规则**发布**

这里的规则使用`BPMN2.0`规范创建，通常使用`xml`文件初始化规则。

关于`BPMN2.0 XML`文件内容，请详见 [《ACTIVITI BPMN2.0 示例说明》](./doc-activiti-bpmn.md)

```
1. Query on deployments and process definitions known to the engine. （查询、发布）
2. Suspend and activate deployments as a whole or specific process definitions. （暂停、启动）
   Suspending means no further operations can be done on them, while activation is the opposite operation.
3. Retrieve various resources such as files contained within the deployment or process diagrams that were auto generated by the engine.
4. Retrieve a POJO version of the process definition which can be used to introspect the process using Java rather than xml.
```


### 规则实例管理 RuntimeService

>  RuntimeService  deals with starting new process instances of process definitions.

针对通过`RepositoryService`创建的规则，`RuntimeService`可以创建出对应规则的`实例(Instance)`。

（简单点理解就是：管理具体规则产生的实际业务工单）

### 任务管理 TaskService

> Everything around tasks is grouped in the TaskService

在工作流中需要人参与的或者需要机器执行的部分成为任务，而`TaskService`是用于管理这些任务的

```
1. Querying tasks assigned to users or groups （查询，根据用户或者分组）
2. Creating new standalone tasks. These are tasks that are not related to a process instances.（创建，独立任务，和流程无关）
3. Manipulating to which user a task is assigned or which users are in some way involved with the task.（任务分配，分派用户以及方式）
4. Claiming and completing a task. （声明和完成任务）
   Claiming means that someone decided to be the assignee for the task, meaning that this user will complete the task.
   Completing means doing the work of the tasks. Typically this is filling in a form of sorts.
```


---
~ 华丽的分割线 ~
---

### 执行者（用户，分组）管理 IdentityService

> The IdentityService is pretty simple. (^_^ 看吧，很简单)

> It allows the management (creation, update, deletion, querying, …​) of groups and users.

管理用户或分组的创建、更新、删除、查询等

> It is important to understand that Activiti actually doesn’t do any checking on users at runtime.

很重要的一点，`Activiti` 是不会验证用户或分组的合法性的~！！！

### 历史记录管理 HistoryService

> The HistoryService exposes all historical data gathered by the Activiti engine.

用于管理查询流程中的历史数据


### 表单管理 FormService （选配项！！！）

> The FormService is an optional service.
（-_- 看吧，这个玩意儿就是个附属的选配）

> This service introduces the concept of a start form and a task form.

> 此服务是用来管理（描述更合适）流程启动表单和任务中表单的

在Activiti中总共有三种表单，动态表单，普通表单和外置表单。

FormService的API操作可以获取到流程启动节点的表单内容以及任务节点的表单内容。

**动态表单**
```xml
<startEvent activiti:initiator="applyUserId" id="start" name="start">
  <extensionElements>
    <activiti:formProperty datePattern="yyyy-MM-dd" id="startDate" name="请假开始日期" required="true" type="date"/>
    <activiti:formProperty datePattern="yyyy-MM-dd" id="endDate" name="请假结束日期" required="true" type="date"/>
    <activiti:formProperty id="reason" name="请假原因" required="true" type="string"/>
  </extensionElements>
</startEvent>
```

在`bpmn20.xml`定义文件中，有关于流程中需要填写的`activiti:formProperty`,这一类便是`动态表单`，可以在开始事件(startEvent)和任务(Task)上设置表单的动态内容，表单的内容都是以key和value的形式数据保存在引擎表中。

**普通表单**
```xml
<startEvent id="begin" name="请假申请" activiti:initiator="applyUserId" activiti:formKey="/demo/leave/startForm"></startEvent>
<userTask id="leaderAudit" name="部门经理审批" activiti:candidateGroups="test" activiti:formKey="/demo/leave/completeForm"></userTask>
```
普通表单的`startEvent `和`userTask `都是需要我们自己来定义维护的，因此布局比动态表单要优美很多。
其中`activiti:formKey`就是来定义我们启动界面或者某个任务环节处理界面的对应的表单标识的key

**外置表单**

> 这种方式常用于基于工作流平台开发的方式，代码写的很少，开发人员只要把表单内容写好保存到.form文件中即可，然后配置每个节点需要的表单名称（form key），实际运行时通过引擎提供的API读取Task对应的form内容输出到页面。

### 管理服务 ManagementService （可能不需要的选配项！！！）

> The ManagementService is typically not needed when coding custom application using Activiti.

> 这玩意儿在第三方进行集成开发的时候压根就不是必须的

```
 1. It allows to retrieve information about the database tables and table metadata. (查询数据库中的信息)
 2. Furthermore, it exposes query capabilities and management operations for jobs. （定时任务，计划任务之类）
    Jobs are used in Activiti for various things such as timers, asynchronous continuations, delayed suspension/activation, etc.
```


## 事件监听 ActivitiEventListener

> It’s possible to register a listener for certain types of events as opposed to getting notified when any type of event is dispatched.

> 用于注册并监听所有ACTIVITI所支持的事件

[《所有ACTIVITI支持的事件》](https://www.activiti.org/userguide/#eventDispatcherEventTypes)
