# ACTIVITI 简明教程

**简介：**

> Activiti is battle-tested Business Process Management.

> Activiti 是一个久经实战的业务工作流管理器

## 核心组成 ProgressEngine

<img src="file:///D:/software/activiti-5.22.0/docs/userguide/images/api.services.png"/>

如上图所示，主要有7个SERVICE提供服务，其中又分常用和不常用：

**常用**

- RepositoryService
- RuntimeService
- TaskService

**注**：以下`规则`特指`业务流程规则（progress）`

### 规则仓库 RepositoryService

> The RepositoryService is probably the first service needed when working with the Activiti engine.

> 通常我们使用`Activiti`时第一个用到的服务就是`RepositoryService`

此服务提供流程的规则管理：规则**查询**、规则**控制**、规则**创建**、规则**发布**

这里的规则使用`BPMN2.0`规范创建

```
1. Query on deployments and process definitions known to the engine. （查询、发布）
2. Suspend and activate deployments as a whole or specific process definitions. （暂停、启动）
   Suspending means no further operations can be done on them, while activation is the opposite operation.
3. Retrieve various resources such as files contained within the deployment or process diagrams that were auto generated by the engine.
4. Retrieve a POJO version of the process definition which can be used to introspect the process using Java rather than xml.
```
#### 举例

通过`RepositoryService`读取`BPMN2.0`标准创建的假期申请流程规则（这里只是流程规则的定义）`ask-for-vacation.bpmn20.xml` (xml格式)

<img src="file:///D:/software/activiti-5.22.0/docs/userguide/images/api.vacationRequest.png" />

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<definitions id="definitions"
             targetNamespace="http://activiti.org/bpmn20"
             xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xmlns:activiti="http://activiti.org/bpmn">

  <process id="vacationRequest" name="Vacation request">

    <startEvent id="request" activiti:initiator="employeeName">
      <extensionElements>
        <activiti:formProperty id="numberOfDays" name="Number of days" type="long" value="1" required="true"/>
        <activiti:formProperty id="startDate" name="First day of holiday (dd-MM-yyy)" datePattern="dd-MM-yyyy hh:mm" type="date" required="true" />
        <activiti:formProperty id="vacationMotivation" name="Motivation" type="string" />
      </extensionElements>
    </startEvent>
    <sequenceFlow id="flow1" sourceRef="request" targetRef="handleRequest" />

    <userTask id="handleRequest" name="Handle vacation request" >
      <documentation>
        ${employeeName} would like to take ${numberOfDays} day(s) of vacation (Motivation: ${vacationMotivation}).
      </documentation>
      <extensionElements>
         <activiti:formProperty id="vacationApproved" name="Do you approve this vacation" type="enum" required="true">
          <activiti:value id="true" name="Approve" />
          <activiti:value id="false" name="Reject" />
        </activiti:formProperty>
        <activiti:formProperty id="managerMotivation" name="Motivation" type="string" />
      </extensionElements>
      <potentialOwner>
        <resourceAssignmentExpression>
          <formalExpression>management</formalExpression>
        </resourceAssignmentExpression>
      </potentialOwner>
    </userTask>
    <sequenceFlow id="flow2" sourceRef="handleRequest" targetRef="requestApprovedDecision" />

    <exclusiveGateway id="requestApprovedDecision" name="Request approved?" />
    <sequenceFlow id="flow3" sourceRef="requestApprovedDecision" targetRef="sendApprovalMail">
      <conditionExpression xsi:type="tFormalExpression">${vacationApproved == 'true'}</conditionExpression>
    </sequenceFlow>

    <task id="sendApprovalMail" name="Send confirmation e-mail" />
    <sequenceFlow id="flow4" sourceRef="sendApprovalMail" targetRef="theEnd1" />
    <endEvent id="theEnd1" />

    <sequenceFlow id="flow5" sourceRef="requestApprovedDecision" targetRef="adjustVacationRequestTask">
      <conditionExpression xsi:type="tFormalExpression">${vacationApproved == 'false'}</conditionExpression>
    </sequenceFlow>

    <userTask id="adjustVacationRequestTask" name="Adjust vacation request">
      <documentation>
        Your manager has disapproved your vacation request for ${numberOfDays} days.
        Reason: ${managerMotivation}
      </documentation>
      <extensionElements>
        <activiti:formProperty id="numberOfDays" name="Number of days" value="${numberOfDays}" type="long" required="true"/>
        <activiti:formProperty id="startDate" name="First day of holiday (dd-MM-yyy)" value="${startDate}" datePattern="dd-MM-yyyy hh:mm" type="date" required="true" />
        <activiti:formProperty id="vacationMotivation" name="Motivation" value="${vacationMotivation}" type="string" />
        <activiti:formProperty id="resendRequest" name="Resend vacation request to manager?" type="enum" required="true">
          <activiti:value id="true" name="Yes" />
          <activiti:value id="false" name="No" />
        </activiti:formProperty>
      </extensionElements>
      <humanPerformer>
        <resourceAssignmentExpression>
          <formalExpression>${employeeName}</formalExpression>
        </resourceAssignmentExpression>
      </humanPerformer>
    </userTask>
    <sequenceFlow id="flow6" sourceRef="adjustVacationRequestTask" targetRef="resendRequestDecision" />

    <exclusiveGateway id="resendRequestDecision" name="Resend request?" />
    <sequenceFlow id="flow7" sourceRef="resendRequestDecision" targetRef="handleRequest">
      <conditionExpression xsi:type="tFormalExpression">${resendRequest == 'true'}</conditionExpression>
    </sequenceFlow>

     <sequenceFlow id="flow8" sourceRef="resendRequestDecision" targetRef="theEnd2">
      <conditionExpression xsi:type="tFormalExpression">${resendRequest == 'false'}</conditionExpression>
    </sequenceFlow>
    <endEvent id="theEnd2" />
  </process>
</definitions>

```
#### BPMN XML说明

**定义规则属性**

```xml
<process id="vacationRequest" name="Vacation request">
```
- `id` 规则ID，以后通过此ID进行检索等操作
- `name`  规则名称

**注**：此处意思:

> 定义一个叫`Vacation request`的流程规则，id 是`vacationRequest`

**定义规则启动相关属性和变量**

```xml
<startEvent id="request" activiti:initiator="employeeName">
  <extensionElements>
    <activiti:formProperty id="numberOfDays" name="Number of days" type="long" value="1" required="true"/>
    <activiti:formProperty id="startDate" name="First day of holiday (dd-MM-yyy)" datePattern="dd-MM-yyyy hh:mm" type="date" required="true" />
    <activiti:formProperty id="vacationMotivation" name="Motivation" type="string" />
  </extensionElements>
</startEvent>
```
- `startEvent`
    @ `id` ID标识
    @ `activiti:initiator` 流程启动变量
    - `extensionElements` 变量列表
        - `activiti:formProperty ` 创建此规则实例时需要初始化的表单变量
        @ `id` 变量标识
        @ `name` 变量显示名
        @ `type` 变量类型
        @ `require` 是否为必须

**注**：此处意思:

> 申请假期需要员工名称(`employeeName`)，以及申请假期的天数(`numberOfDays`)，开始时间(`startDate`)，请假事由(`vacationMotivation`)

### 规则实例管理 RuntimeService

>  RuntimeService  deals with starting new process instances of process definitions.

针对通过`RepositoryService`创建的规则，`RuntimeService`可以创建出对应规则的`实例(Instance)`。（简单点理解就是：管理具体规则产生的实际业务工单）

### TaskService